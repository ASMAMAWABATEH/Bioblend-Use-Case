#!/usr/bin/env python3
"""
upload_and_run_tool.py - Complete BioBlend upload + tool execution pipeline
"""
from bioblend.galaxy import GalaxyInstance
import time
import sys
import os

# ----------------------------------------------------------------------
# Configuration
# ----------------------------------------------------------------------
GALAXY_URL = "http://localhost:8080"
API_KEY = os.getenv("GALAXY_API_KEY", "demo_user")  # âœ… Secure

HISTORY_NAME = "biobhistory"                       # âœ… Fixed
INPUT_FILE = "bioblend_history.fastq"
FILE_TYPE = "fastqsanger"
TOOL_ID = "cat1"                                   # Simple test tool

def wait_for_job(gi, job_id, timeout=600, interval=5):
    """Poll job state until complete or timeout."""
    start = time.time()
    while True:
        state = gi.jobs.show_job(job_id)["state"]
        print(f"Job state: {state}")
        
        if state in ["ok", "error"]:
            return state
        if (time.time() - start) > timeout:
            return "timeout"
        time.sleep(interval)

def main():
    print("ğŸ”— Connecting to Galaxy...")
    gi = GalaxyInstance(url=GALAXY_URL, key=API_KEY)
    
    print(f"ğŸ“ Creating history: {HISTORY_NAME}")
    history = gi.histories.create_history(HISTORY_NAME)
    history_id = history["id"]
    
    print(f"ğŸ“¤ Uploading '{INPUT_FILE}'...")
    if not os.path.exists(INPUT_FILE):
        print(f"âŒ {INPUT_FILE} not found!")
        sys.exit(1)
        
    upload = gi.tools.upload_file(INPUT_FILE, history_id, file_type=FILE_TYPE)
    dataset_id = upload["outputs"][0]["id"]
    print(f"âœ… Dataset ID: {dataset_id}")
    
    print(f"âš™ï¸ Running tool: {TOOL_ID}")
    run = gi.tools.run_tool(
        history_id=history_id,
        tool_id=TOOL_ID,
        tool_inputs={"input1": {"src": "hda", "id": dataset_id}}
    )
    job_id = run["jobs"][0]["id"]
    
    print(f"â³ Waiting for job {job_id}...")
    state = wait_for_job(gi, job_id)
    
    if state != "ok":
        print(f"âŒ Job failed: {state}")
        sys.exit(1)
    
    print("âœ… Job complete!")
    outputs = gi.histories.show_history(history_id, contents=True)
    print("ğŸ“‹ Outputs:")
    for item in outputs:
        print(f"  - {item['name']} [{item['state']}]")
    
    print("ğŸ‰ Pipeline complete!")

if __name__ == "__main__":
    main()